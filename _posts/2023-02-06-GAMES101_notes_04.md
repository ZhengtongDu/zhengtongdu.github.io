---
layout: post
title: GAMES101_notes_04
date: 2023-02-06 23:32 +0800
tags: ["Learning Notes", "GAMES101"]
toc: true
---

> GAMES101: 现代计算机图形学入门
>
> 笔记04：Ray-Tracing

## Lecture 13 Ray Tracing 1(Whitted-Style Ray Tracing)

### Why Ray Tracing

- Rasterization couldn't handle __global__ effects well
  - (soft) shadows
  - especially when the light bounces __more than once__
- Rasterization is fast, but quality is relatively low
- Ray tracing is accurate, but is very slow
  - Rasterization: real-time, ray tracing: offline
  - ~10K CPU core hours to render one frame in production

### Basic Ray Tracing Algorithm

Three ideas about light rays

1. Light travels in straight lines(though this is wrong)
2. Light rays do not "collide" with each other if they cross(though this is still wrong)
3. Light rays travel from the light sources to the eye(but the physics is invariant under path reversal - reciprocity)

#### Ray Casting

1. Generate an image by __casting one ray per pixel__
2. Check for shadows by __sending a ray to the light__

#### Recursive(Whitted-Style) Ray Tracing

- 考虑每个从眼睛出发的光线到每个物体处发生的折射和反射的结果；
- 对于每个折射和反射的结果，分别计算其到光源的点的着色结果，加总后得到最后的着色值
- 每次折射后的结果都会发生一定的能量损耗

### Ray-Surface Intersection

Ray is defined by its origin and a direction vector

$$
    \mathbf{r}(t) = \mathbf{o} + t\mathbf{d}, \quad 0 \le t < \infty
$$

#### Ray Intersection With Sphere

$$
    \mathrm{Ray: } \mathbf{r}(t) = \mathbf{o} + t\mathbf{d}, \quad \\
    \mathrm{Sphere: } \mathbf{p} : (\mathbf{p} - \mathbf{c})^2 - R^2 = 0
$$

#### Ray Intersection With Implicit Surface

$$
    \mathrm{Ray: }\quad \mathbf{r}(t) = \mathbf{o} + t\mathbf{d}, \quad \\
    \mathrm{General\ implicit\ surface: }\quad \mathbf{p} : f(\mathbf{p}) = 0\\
    \mathrm{Substitute\ ray\ equation: }\quad f(\mathbf{o} + t\mathbf{d}) = 0
$$

#### Ray Intersection With Triangle Mesh

Why?

- Rendering: visibility, shadows, lighting
- Geometry: inside/outside test

How?

- Simple idea: just intersect ray with each triangle
- Simple, but slow(acceleration? -- later)
- Note: can have 0, 1 intersections(ignoring multiple intersections)

#### Ray Intersection With Triangle

Triangle is in a plane

- Ray-plane intersection
- Test if hit point is inside triangle

Plane is defined by normal vector and a point on plane

$$
    \mathbf{p}: (\mathbf{p} - \mathbf{p}')\cdot\mathbf{N} = 0\qquad
    ax + by + cz + d = 0
$$

#### Moller Trumbore Algorithm

A fast approach, giving barycentric coordinate directly

Derivation in the discussion section!

$$
    \mathbf{O} + t\mathbf{D} = (1 - b_1 - b_2)\mathbf{P}_0 + b_1 \mathbf{P}_1 + b_2\mathbf{P}_2
$$

### Accelerating Ray-Surface Intersection

Simple ray-scene intersection

- Exhaustively test ray-intersection with every object
- Find the closest hit(with minimum t)

#### Bounding Volumes

Quick way to avoid intersections: bound complex object with a simple volume

- Object is fully contained in the volume
- If it doesn't hit the volume, it doesn't hit the object
- So test BVol first, then test object if it hits

Ray-Intersection with Box

- Understanding: box is the intersection of 3 pairs of slabs
- Specifically, we often use an Axis-Aligned Bounding Box(AABB)

Key ideas

- The ray enters the box only when it enters all pairs of slabs
- The ray exits the bos as long as it exits any pair of slabs

具体操作方法：

- 考虑光线通过分别通过每个方向的两个平面的时间$t_{\min},\ t_{\max}$
- 如果进入时间的最大值小于射出时间的最小值，则说明光线同包围盒有交点
- 对于时间为负值的情况
  - 如果进入时间为负，离开时间为正，则可以说明光源在盒中；
  - 如果离开时间为负，说明盒子沿光路在光源后面
- In summary, ray and AABB intersect iff
  - $t_{enter} < t_{exit}\ \mathrm{and}\ t_{exit} \ge 0$

## Lecture 14 Ray Tracing 2(Acceleration & Radiometry)

本讲内容：

- Using AABBs to accelerate ray tracing
  - Uniform grids
  - Spatial partitions
- Basic radiometry(辐射度量学)

### Uniform Spatial Partitions(Grids)

Preprocess - Build Acceleration Grid

- Find bounding box
- Create grid
- Store each object in overlapping cells

Step through grid in ray traversal order, for each grid cell test intersection with all objects stored at that cell.（类似分治的想法）

存在的问题：当场景中的物体分布过于稀疏的时候，会存在冗余运算的情况。

### Spatial Partitions

Examples:

- Oct-Tree 每次沿每个维度进行分割
- KD-Tree 每次只沿一个维度进行分割
- BSP-Tree 每次沿一个方向进行分割

考虑到AABB的结构，采用KD-Tree是较为合适的解决方法

Data Structure for KD-Trees

- Internal nodes store
  - split axis: x-, y- or z-axis
  - split position: coordinate of split plane along axis
  - children: pointers to child nodes
  - __No objects are stored in internal nodes__
- Leaf nodes store
  - list of objects

对于构建好的数据结构，只要进行遍历，判断光线经过每个结构时是否可能相交，就可以进行下一步的判断。

但是KD-Tree(还有八叉树)来说，还有如下两个问题难以解决：

- 同一个物体可能存在多个盒子里
- 判断三角形是否和盒子相交很困难

因此提出了如下的解决方法：

### Object Partitions & Bounding Volume Hierarchy(BVH)

采取和KD-Tree相反的思路，不再对空间进行划分，而是对物体进行划分，然后构建新的子包围盒，这样得到的结构，虽然包围盒可能彼此相交且空间划分并不完全均匀，但是可以保证每个物体只存在于一个包围盒中，且不需要担心盒子和物体的相交问题（因为盒子是由包围关系确定的）

Summary: Building BVHs

- Find bounding box
- Recursively split set of objects in two subsets
- __Recompute__ the bounding box of the subsets
- Stop when necessary
- Store objects in each leaf node

细节问题：

- How to subdivide a node?
  - Choose a dimension to split
  - Heuristic #1: Always choose the longest axis in node（保证盒子尽可能是方的）
  - Heuristic #2: Split node at location of __median__ object
- Termination criteria?
  - Heuristic: stop when node contains few elements(e.g. 5)

Data Structure for BVHs

- Internal nodes store
  - Bounding box
  - Children: pointers to child nodes
- Leaf nodes store
  - Bounding box
  - List of objects
- Nodes represent subset of primitives in scene
  - All objects in subtree

BVH Traversal(pseudocode)

```c++
Intersect(Ray ray, BVH node){
  if(ray misses node.bbox) return;

  if(node is a leaf node)
    test intersection with all objs;
    return closest intersection;

  hit1 = Intersect(ray, node.child1);
  hit2 = Intersect(ray, node.child2);

  return the closer of hit1, hit2;
}
```

Spatial vs. Object Partitions

- Spatial partition(e.g. KD-Tree)
  - Partition space into non-overlapping regions
  - An object can be contained in multiple regions
- Object partition(e.g. BVH)
  - Partition set of objects into disjoint subsets
  - Bounding boxes for each set may overlap in space

### Basic Radiometry

